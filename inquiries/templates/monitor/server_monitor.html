{% load static %}
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>ã‚µãƒ¼ãƒãƒ¼ç›£è¦–</title>
    <link rel="stylesheet" href="{% static 'inquiries/css/style.css' %}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <h1>ã‚µãƒ¼ãƒãƒ¼ç›£è¦–</h1>
    
    <div class="monitor-container">
        <h2>ğŸ“Š ã‚·ã‚¹ãƒ†ãƒ ãƒªã‚½ãƒ¼ã‚¹ä½¿ç”¨ç‡</h2>
        
        <!-- CPUãƒ»ãƒ¡ãƒ¢ãƒªãƒ»ãƒ‡ã‚£ã‚¹ã‚¯ä½¿ç”¨ç‡ã®ã‚°ãƒ©ãƒ•ï¼ˆç™½æ ã®ä¸­ã«é…ç½®ï¼‰ -->
        <div class="graph-wrapper">
            <div class="graph-row">
                <div class="graph-box">
                    <h3>CPU ä½¿ç”¨ç‡</h3>
                    <canvas id="cpuChart"></canvas>
                </div>
                <div class="graph-box">
                    <h3>ãƒ¡ãƒ¢ãƒªä½¿ç”¨ç‡</h3>
                    <canvas id="memoryChart"></canvas>
                </div>
            </div>
            <div class="graph-box disk-center">
                <h3>ãƒ‡ã‚£ã‚¹ã‚¯ä½¿ç”¨ç‡</h3>
                <canvas id="diskChart"></canvas>
            </div>
        </div>

        


        <div class="monitor-section">
            <p><strong>CPU ä½¿ç”¨ç‡:</strong> <span id="cpu_usage">å–å¾—ä¸­...</span>%</p>
            <p><strong>ãƒ¡ãƒ¢ãƒªä½¿ç”¨ç‡:</strong> <span id="memory_usage">å–å¾—ä¸­...</span>%</p>
            <p><strong>ãƒ‡ã‚£ã‚¹ã‚¯ä½¿ç”¨ç‡:</strong> <span id="disk_percent">å–å¾—ä¸­...</span>%</p>
            <p><strong>ç©ºãå®¹é‡:</strong> <span id="disk_free">å–å¾—ä¸­...</span> GB / <span id="disk_total">å–å¾—ä¸­...</span> GB</p>
        </div>

        <!-- ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ç›£è¦– -->
        <h3>ğŸŒ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ä½¿ç”¨çŠ¶æ³</h3>
        <p><strong>é€ä¿¡ãƒ‡ãƒ¼ã‚¿:</strong> <span id="net_sent">å–å¾—ä¸­...</span> MB</p>
        <p><strong>å—ä¿¡ãƒ‡ãƒ¼ã‚¿:</strong> <span id="net_recv">å–å¾—ä¸­...</span> MB</p>

        <!-- ãƒ—ãƒ­ã‚»ã‚¹ç›£è¦– -->
        <h3>ğŸ” å®Ÿè¡Œä¸­ã®ãƒ—ãƒ­ã‚»ã‚¹</h3>
        <table>
            <thead>
                <tr>
                    <th>PID</th>
                    <th>ãƒ—ãƒ­ã‚»ã‚¹å</th>
                    <th>CPUä½¿ç”¨ç‡</th>
                    <th>ãƒ¡ãƒ¢ãƒªä½¿ç”¨ç‡</th>
                </tr>
            </thead>
            <tbody id="process-list">
                <tr><td colspan="4">å–å¾—ä¸­...</td></tr>
            </tbody>
        </table>

        <!-- ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ç›£è¦– -->
        <h3>âš ï¸ ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°</h3>
        <pre id="error_logs">å–å¾—ä¸­...</pre>

        <!-- ã‚¢ãƒ©ãƒ¼ãƒˆè¡¨ç¤º -->
        <div id="alert-box" class="alert-box" style="display: none;">
            âš ï¸ é«˜è² è·çŠ¶æ…‹ï¼ CPUãƒ»ãƒ¡ãƒ¢ãƒªãƒ»ãƒ‡ã‚£ã‚¹ã‚¯ã®ä½¿ç”¨ç‡ãŒ90%ã‚’è¶…ãˆã¾ã—ãŸï¼
        </div>
    </div>

    <!-- ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹ãƒœã‚¿ãƒ³ -->
    <div class="home-button">
        <a class="btn btn-home" href="{% url 'home' %}">ãƒ›ãƒ¼ãƒ ã¸æˆ»ã‚‹</a>
    </div>

    <script>
        let cpuChart, memoryChart, diskChart;

        async function fetchServerData() {
            try {
                const response = await fetch("{% url 'get_system_stats' %}");
                const data = await response.json();

                // CPUãƒ»ãƒ¡ãƒ¢ãƒªãƒ»ãƒ‡ã‚£ã‚¹ã‚¯ä½¿ç”¨ç‡ã®æ›´æ–°
                document.getElementById("cpu_usage").textContent = data.cpu_usage;
                document.getElementById("memory_usage").textContent = data.memory_usage;
                document.getElementById("disk_percent").textContent = data.disk_percent;
                document.getElementById("disk_free").textContent = data.disk_free;
                document.getElementById("disk_total").textContent = data.disk_total;

                // ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯é€šä¿¡é‡ã®æ›´æ–°
                document.getElementById("net_sent").textContent = data.bytes_sent;
                document.getElementById("net_recv").textContent = data.bytes_recv;

                // ãƒ—ãƒ­ã‚»ã‚¹ä¸€è¦§ã®æ›´æ–°
                let processHtml = "";
                data.processes.forEach(proc => {
                    processHtml += `<tr>
                        <td>${proc.pid}</td>
                        <td>${proc.name}</td>
                        <td>${proc.cpu_percent}%</td>
                        <td>${proc.memory_percent}%</td>
                    </tr>`;
                });
                document.getElementById("process-list").innerHTML = processHtml;

                // ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã®æ›´æ–°
                document.getElementById("error_logs").textContent = data.error_logs;

                // ã‚¢ãƒ©ãƒ¼ãƒˆè¡¨ç¤ºï¼ˆ90%ä»¥ä¸Šï¼‰
                const alertBox = document.getElementById("alert-box");
                if (data.cpu_usage >= 90 || data.memory_usage >= 90 || data.disk_percent >= 90) {
                    alertBox.style.display = "block";
                } else {
                    alertBox.style.display = "none";
                }

                // ã‚°ãƒ©ãƒ•ã‚’æ›´æ–°
                updateCharts(data.cpu_usage, data.memory_usage, data.disk_percent);

            } catch (error) {
                console.error("ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ:", error);
            }
        }

        function updateCharts(cpuUsage, memoryUsage, diskUsage) {
            const ctxCpu = document.getElementById('cpuChart').getContext('2d');
            const ctxMemory = document.getElementById('memoryChart').getContext('2d');
            const ctxDisk = document.getElementById('diskChart').getContext('2d');

            if (!cpuChart) {
                cpuChart = new Chart(ctxCpu, {
                    type: 'doughnut',
                    data: {
                        labels: ['ä½¿ç”¨ä¸­', 'ç©ºã'],
                        datasets: [{ data: [cpuUsage, 100 - cpuUsage], backgroundColor: ['red', 'lightgray'] }]
                    }
                });
            } else {
                cpuChart.data.datasets[0].data = [cpuUsage, 100 - cpuUsage];
                cpuChart.update();
            }

            if (!memoryChart) {
                memoryChart = new Chart(ctxMemory, {
                    type: 'doughnut',
                    data: {
                        labels: ['ä½¿ç”¨ä¸­', 'ç©ºã'],
                        datasets: [{ data: [memoryUsage, 100 - memoryUsage], backgroundColor: ['blue', 'lightgray'] }]
                    }
                });
            } else {
                memoryChart.data.datasets[0].data = [memoryUsage, 100 - memoryUsage];
                memoryChart.update();
            }

            if (!diskChart) {
                diskChart = new Chart(ctxDisk, {
                    type: 'doughnut',
                    data: {
                        labels: ['ä½¿ç”¨ä¸­', 'ç©ºã'],
                        datasets: [{ data: [diskUsage, 100 - diskUsage], backgroundColor: ['purple', 'lightgray'] }]
                    }
                });
            } else {
                diskChart.data.datasets[0].data = [diskUsage, 100 - diskUsage];
                diskChart.update();
            }
        }

        fetchServerData();
        setInterval(fetchServerData, 5000);
    </script>
</body>
</html>
